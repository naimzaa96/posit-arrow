{
  "hash": "62602546d12ab790ca112e42f2d3549a",
  "result": {
    "markdown": "---\ntitle: \"Data Manipulation Part 1 - Exercises\"\nexecute:\n  echo: true\n  messages: false\n  warning: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(arrow)\nlibrary(dplyr)\nlibrary(stringr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi <- open_dataset(here::here(\"data/nyc-taxi\"))\nnyc_taxi\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nFileSystemDataset with 120 Parquet files\nvendor_name: string\npickup_datetime: timestamp[ms]\ndropoff_datetime: timestamp[ms]\npassenger_count: int64\ntrip_distance: double\npickup_longitude: double\npickup_latitude: double\nrate_code: string\nstore_and_fwd: string\ndropoff_longitude: double\ndropoff_latitude: double\npayment_type: string\nfare_amount: double\nextra: double\nmta_tax: double\ntip_amount: double\ntolls_amount: double\ntotal_amount: double\nimprovement_surcharge: double\ncongestion_surcharge: double\npickup_location_id: int64\ndropoff_location_id: int64\nyear: int32\nmonth: int32\n```\n:::\n:::\n\n\n::: {#exercise-compute-collect .callout-tip}\n# Using `compute()` and `collect()`\n\n::: panel-tabset\n## Problem\n\n1.  How many taxi fares in the dataset had a total amount greater than \\$100?\n\n2.  How many distinct pickup locations are in the dataset?\n\n## Solution 1\n\n\n::: {.cell hash='02-data-manipulation-1-exercises_cache/html/compute-collect-1_9bc20910222bba20b6903b8608d803b4'}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  filter(total_amount > 100) %>%\n  nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1518869\n```\n:::\n:::\n\n\n## Solution 2\n\n\n::: {.cell hash='02-data-manipulation-1-exercises_cache/html/compute-collect-2_ebe790d6dccb3b995417c7f7ae8f63f9'}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  distinct(pickup_longitude, pickup_latitude) %>%\n  compute() %>%\n  nrow()\n```\n:::\n\n:::\n:::\n\n::: {#exercise-dplyr-api .callout-tip}\n# Using the dplyr API in arrow\n\n::: panel-tabset\n## Problem\n\n1.  Use the `dplyr::filter()` and `stringr::str_ends()` to return a subset of the data which is a) from September 2020, and b) the value in `vendor_name` ends with the letter \"S\".\n\n2.  Try to use the `stringr` function `str_replace_na()` to replace any `NA` values in the `vendor_name` column with the string \"No vendor\" instead. What happens, and why?\n\n3.  Bonus question: see if you can find a different way of completing the task in question 2.\n\n## Solution 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  filter(str_ends(vendor_name, \"S\"), year == 2020,  month == 9) %>%\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 847,149 × 24\n   vendor_name pickup_datetime     dropoff_datetime    passenger_count\n   <chr>       <dttm>              <dttm>                        <int>\n 1 VTS         2020-09-03 01:27:09 2020-09-03 01:36:37               1\n 2 VTS         2020-09-03 01:50:56 2020-09-03 02:09:16               1\n 3 VTS         2020-09-03 01:00:21 2020-09-03 01:04:18               2\n 4 VTS         2020-09-03 01:48:16 2020-09-03 02:06:04               2\n 5 VTS         2020-09-03 01:37:23 2020-09-03 01:48:16               1\n 6 VTS         2020-09-03 01:05:52 2020-09-03 01:13:17               1\n 7 VTS         2020-09-03 01:26:54 2020-09-03 01:31:10               1\n 8 VTS         2020-09-03 01:08:05 2020-09-03 01:12:33               1\n 9 VTS         2020-09-03 01:24:36 2020-09-03 01:37:46               1\n10 VTS         2020-09-03 01:49:32 2020-09-03 01:55:51               1\n# ℹ 847,139 more rows\n# ℹ 20 more variables: trip_distance <dbl>, pickup_longitude <dbl>,\n#   pickup_latitude <dbl>, rate_code <chr>, store_and_fwd <chr>,\n#   dropoff_longitude <dbl>, dropoff_latitude <dbl>, payment_type <chr>,\n#   fare_amount <dbl>, extra <dbl>, mta_tax <dbl>, tip_amount <dbl>,\n#   tolls_amount <dbl>, total_amount <dbl>, improvement_surcharge <dbl>,\n#   congestion_surcharge <dbl>, pickup_location_id <int>, …\n```\n:::\n:::\n\n\n## Solution 2 and 3\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  mutate(vendor_name = stringr::str_replace_na(vendor_name, \"No vendor\")) %>%\n  collect()\n```\n\n::: {.cell-output .cell-output-error}\n```\nError: Expression stringr::str_replace_na(vendor_name, \"No vendor\") not supported in Arrow\nCall collect() first to pull data into R.\n```\n:::\n:::\n\n\nThis won't work as `stringr::str_replace_na()` hasn't been implemented in Arrow. You could try using `mutate()` and `ifelse()` here instead.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  mutate(vendor_name = ifelse(is.na(vendor_name), \"No vendor\", vendor_name)) %>%\n  collect()\n```\n:::\n\n\nOr, if you only needed a subset of the data, you could apply the function after collecting it into R memory.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi %>%\n  filter(year == 2019, month == 10) %>% # smaller subset of the data\n  collect() %>%\n  mutate(vendor_name = stringr::str_replace_na(vendor_name, \"No vendor\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7,213,588 × 24\n   vendor_name pickup_datetime     dropoff_datetime    passenger_count\n   <chr>       <dttm>              <dttm>                        <int>\n 1 VTS         2019-10-01 05:25:25 2019-10-01 05:42:23               2\n 2 VTS         2019-10-01 05:19:14 2019-10-01 05:39:20               1\n 3 VTS         2019-10-01 05:42:19 2019-10-01 05:49:06               2\n 4 VTS         2019-10-01 05:46:56 2019-10-01 05:58:38               5\n 5 CMT         2019-10-01 05:05:24 2019-10-01 05:15:05               1\n 6 CMT         2019-10-01 05:39:12 2019-10-01 05:55:03               3\n 7 CMT         2019-10-01 05:58:11 2019-10-01 06:02:56               2\n 8 CMT         2019-10-01 05:07:30 2019-10-01 05:18:38               1\n 9 CMT         2019-10-01 05:23:52 2019-10-01 05:25:52               3\n10 CMT         2019-10-01 05:42:31 2019-10-01 05:56:08               1\n# ℹ 7,213,578 more rows\n# ℹ 20 more variables: trip_distance <dbl>, pickup_longitude <dbl>,\n#   pickup_latitude <dbl>, rate_code <chr>, store_and_fwd <chr>,\n#   dropoff_longitude <dbl>, dropoff_latitude <dbl>, payment_type <chr>,\n#   fare_amount <dbl>, extra <dbl>, mta_tax <dbl>, tip_amount <dbl>,\n#   tolls_amount <dbl>, total_amount <dbl>, improvement_surcharge <dbl>,\n#   congestion_surcharge <dbl>, pickup_location_id <int>, …\n```\n:::\n:::\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}